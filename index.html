<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="rainbow.png" type="image/png" />
    <link rel="shortcut icon" href="rainbow.png" />
    <link rel="apple-touch-icon" href="rainbow.png" />
    <title>BOIOLOMETRO</title>
    <style>
      body {
        background: #111;
        color: #eee;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
      }

      .vu-container {
        position: relative;
        width: min(90vw, 500px);
        padding-bottom: 80px;
      }

      .vu-container img {
        width: 100%;
        display: block;
      }

      .needle {
        position: absolute;
        width: 4px;
        height: 300px;
        background: black;
        bottom: 20px;
        left: 50%;
        transform-origin: bottom center;
        transform: translateX(-50%) rotate(-35deg);
        border-radius: 2px;
        pointer-events: none;
      }

      .pivot {
        position: absolute;
        width: 14px;
        height: 14px;
        background: black;
        border-radius: 50%;
        bottom: 14px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
      }

      .led {
        position: absolute;
        width: 25px;
        height: 25px;
        background: rgb(179, 7, 7);
        border-radius: 50%;
        bottom: 308px;
        left: 50%;
        transform: translateX(-50%);
        visibility: hidden;
      }

      button {
        margin-top: 40px;
        padding: 12px 30px;
        font-size: 16px;
        border-radius: 30px;
        cursor: pointer;
        user-select: none;
      }

      /* engrenagem */
      .gear {
        position: fixed;
        top: 12px;
        right: 12px;
        font-size: 26px;
        cursor: pointer;
        user-select: none;
      }

      /* modal */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: #222;
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
      }

      .control {
        margin-bottom: 16px;
      }

      .control label {
        display: block;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .control span {
        float: right;
        font-weight: bold;
      }

      input[type="range"] {
        width: 100%;
      }
    </style>
  </head>

  <body>
    <div class="gear" id="gear">⚙️</div>

    <div class="vu-container">
      <img src="vu.jpg" alt="VU Meter" />
      <div class="needle" id="needle"></div>
      <div class="pivot"></div>
      <div class="led" id="led"></div>
    </div>

    <button id="btn">BOIOLÔMETRO</button>

    <!-- MODAL -->
    <div class="modal" id="modal">
      <div class="modal-content">
        <h3>Ajustes</h3>

        <div class="control">
          <label>
            Ângulo mínimo
            <span id="minVal"></span>
          </label>
          <input type="range" id="minAngle" min="-80" max="0" />
        </div>

        <div class="control">
          <label>
            Ângulo máximo
            <span id="maxVal"></span>
          </label>
          <input type="range" id="maxAngle" min="0" max="80" />
        </div>

        <div class="control">
          <label>
            Altura do LED
            <span id="ledVal"></span>
          </label>
          <input type="range" id="ledPos" min="200" max="360" />
        </div>

        <button onclick="closeModal()">Fechar</button>
      </div>
    </div>

    <script>
      const needle = document.getElementById("needle");
      const led = document.getElementById("led");
      const btn = document.getElementById("btn");

      /* ======= MEMÓRIA ======= */
      let MIN_ANGLE = Number(localStorage.getItem("minAngle")) || -41;
      let MAX_ANGLE = Number(localStorage.getItem("maxAngle")) || 41;
      let LED_POS = Number(localStorage.getItem("ledPos")) || 308;

      led.style.bottom = LED_POS + "px";

      let currentAngle = MIN_ANGLE;
      let targetAngle = MIN_ANGLE;
      let lastTime = null;

      /* ======= ÁUDIO ======= */
      let audioCtx, osc, gain;

      function initAudio() {
        if (audioCtx) return;
        audioCtx = new AudioContext();
        osc = audioCtx.createOscillator();
        gain = audioCtx.createGain();
        osc.type = "sine";
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        gain.gain.value = 0;
        osc.start();
      }

      function soundOn(level) {
        initAudio();
        osc.frequency.value = 120 + level * 880;
        gain.gain.value = level * 0.15;
      }

      function soundOff() {
        if (gain) gain.gain.value = 0;
      }

      function setLevel(level) {
        targetAngle = MIN_ANGLE + (MAX_ANGLE - MIN_ANGLE) * level;
        soundOn(level);
        led.style.visibility = level > 0.85 ? "visible" : "hidden";
      }

      function animate(t) {
        if (!lastTime) lastTime = t;
        const dt = t - lastTime;
        lastTime = t;

        currentAngle += (targetAngle - currentAngle) * 0.015 * dt;
        needle.style.transform = `translateX(-50%) rotate(${currentAngle}deg)`;

        requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);

      btn.addEventListener("pointerdown", () => setLevel(1));
      btn.addEventListener("pointerup", release);
      btn.addEventListener("pointerleave", release);
      btn.addEventListener("pointercancel", release);

      function release() {
        targetAngle = MIN_ANGLE;
        soundOff();
        led.style.visibility = "hidden";
      }

      /* ===== MODAL ===== */
      const modal = document.getElementById("modal");
      const gear = document.getElementById("gear");

      const minSlider = document.getElementById("minAngle");
      const maxSlider = document.getElementById("maxAngle");
      const ledSlider = document.getElementById("ledPos");

      const minVal = document.getElementById("minVal");
      const maxVal = document.getElementById("maxVal");
      const ledVal = document.getElementById("ledVal");

      function openModal() {
        modal.style.display = "flex";
      }
      function closeModal() {
        modal.style.display = "none";
      }

      gear.onclick = openModal;
      modal.onclick = (e) => e.target === modal && closeModal();

      function sync() {
        minVal.textContent = MIN_ANGLE + "°";
        maxVal.textContent = MAX_ANGLE + "°";
        ledVal.textContent = LED_POS + "px";
      }

      minSlider.value = MIN_ANGLE;
      maxSlider.value = MAX_ANGLE;
      ledSlider.value = LED_POS;
      sync();

      minSlider.oninput = (e) => {
        MIN_ANGLE = Number(e.target.value);
        localStorage.setItem("minAngle", MIN_ANGLE);
        sync();
      };

      maxSlider.oninput = (e) => {
        MAX_ANGLE = Number(e.target.value);
        localStorage.setItem("maxAngle", MAX_ANGLE);
        sync();
      };

      ledSlider.oninput = (e) => {
        LED_POS = Number(e.target.value);
        led.style.bottom = LED_POS + "px";
        localStorage.setItem("ledPos", LED_POS);
        sync();
      };
    </script>
  </body>
</html>
